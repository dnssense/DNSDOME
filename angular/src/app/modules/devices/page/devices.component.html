<div class="rk-base-card">
  <div class="card-item">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 p-0">
          <h5 class="page-title">Device</h5>
        </div>

        <rk-modal #selectedBoxModal>
          <rk-modal-header>
            <rk-modal-header-title>
              <h5>{{ selectedBox?.host }}</h5>
            </rk-modal-header-title>

            <rk-modal-header-close (click)="selectedBoxModal.toggle()"></rk-modal-header-close>
          </rk-modal-header>

          <rk-modal-body>

            <div class="container-fluid">
              <div class="row" *ngIf="selectedBox">
                <div class="col-12 mt-3">
                  <input type="text" class="rk-input w-100" placeholder="Box Name" [(ngModel)]="selectedBox.host">
                </div>

                <div class="col-12 mt-3">
                  <input type="text" class="rk-input w-100" placeholder="Block Message"
                    [(ngModel)]="selectedBox.agent.blockMessage">
                </div>

                <div class="col-12 mt-3">
                  <rk-select [options]="securityProfilesForSelect" [(value)]="selectedBox.agent.rootProfile.id">
                  </rk-select>
                </div>

                <div class="col-6 mt-3">
                  <div class="rk-radio my-0">
                    <input type="radio" id="rd-enable" [(ngModel)]="selectedBox.agent.isCpEnabled" name="rd-enables"
                      [value]="true">
                    <label for="rd-enable">Enable</label>
                  </div>
                </div>

                <div class="col-6 mt-3">
                  <div class="rk-radio my-0">
                    <input type="radio" id="rd-disable" [(ngModel)]="selectedBox.agent.isCpEnabled" name="rd-enables"
                      [value]="false">
                    <label for="rd-disable">Disable</label>
                  </div>
                </div>

                <div class="col-12 mt-3" *ngIf="selectedBox.agent.isCpEnabled">
                  <input type="text" class="rk-input w-100" (keydown)="checkKeydown($event)"
                    [(ngModel)]="selectedBox.agent.captivePortalIp" placeholder="Captive Portal IP">
                </div>
              </div>
            </div>

          </rk-modal-body>

          <rk-modal-footer>
            <button class="btn btn-small w-100 mr-2" (click)="saveBox()">Apply</button>
            <button class="btn btn-small w-100 btn-default" (click)="cleanBoxForm()">Clean</button>
          </rk-modal-footer>
        </rk-modal>

        <div class="col-12 p-0 mt-3">
          <rk-table-container class="m-0">
            <div class="rk-table-container-header">
              <div class="top-content justify-content-between">
                <div class="rk-table-title">Local DNS Relay Servers</div>
              </div>
            </div>

            <rk-table [showPagination]="false">
              <ng-template #header>
                <tr>
                  <th>Profile</th>
                  <th>Security Profile</th>
                  <th>Is CP Enabled</th>
                  <th>Captive Portal IP</th>
                  <th colspan="2">Operation</th>
                </tr>
              </ng-template>

              <ng-template #body>
                <tr *ngFor="let b of boxes">
                  <td>
                    <i-feather name="server" class="icon-blue-grey mr-2"></i-feather>
                    {{ b.host }}
                  </td>
                  <td>
                    <ng-container *ngIf="b.agent; else elseTemplate221">
                      <ng-container *ngIf="b.agent.rootProfile; else elseTemplate123">{{b.agent.rootProfile?.name}}
                      </ng-container>
                      <ng-template #elseTemplate123>No Profile!</ng-template>
                    </ng-container>
                    <ng-template #elseTemplate221>No Agent!</ng-template>
                  </td>
                  <td>
                    <i-feather [name]="b.agent?.isCpEnabled ? 'check' : 'x'"></i-feather>
                  </td>
                  <td>
                    <ng-container *ngIf="b.agent?.isCpEnabled; else elseTemplate2">{{b.agent?.captivePortalIp}}
                    </ng-container>
                    <ng-template #elseTemplate2>-</ng-template>
                  </td>
                  <td style="width: 60px">
                    <button class=" btn btn-link btn-icon p-0 hover-gray" (click)="editBox(b)">
                      <i-feather name="edit-3"></i-feather>
                    </button>
                  </td>
                  <td style=" width: 60px" (click)="deleteBox(b.id)">
                    <button class=" btn btn-link btn-icon p-0 hover-gray">
                      <i-feather name="trash-2"></i-feather>
                    </button>
                  </td>
                </tr>
              </ng-template>
            </rk-table>
          </rk-table-container>
        </div>

        <rk-modal #groupAgentModal (close)="closeGroupAgentModal($event)">
          <rk-modal-header icon="plus">
            <rk-modal-header-title>
              <h5>{{ selectedGroupAgent.agentGroup.id ? 'Edit' : 'Create New' }} Group </h5>
            </rk-modal-header-title>

            <rk-modal-header-close (click)="groupAgentModal.toggle()"></rk-modal-header-close>
          </rk-modal-header>

          <rk-modal-body>

            <div class="container-fluid">
              <div class="row">
                <div class="col-12 mt-3">
                  <input type="text" class="rk-input w-100" placeholder="Group Name" [(ngModel)]="groupName">
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-12 mt-3" *ngFor="let profile of securityProfiles; let index = index">
                  <div class="rk-radio my-0">
                    <input type="radio" id="rd-sec-{{ index }}" name="securityProfileRd"
                      [(ngModel)]="selectedProfileRadio" [value]="profile.id">
                    <label for="rd-sec-{{ index }}">{{ profile.name }}</label>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mt-3">
                  <h5 class="rk-group-title">Select Devices to Join Group</h5>
                </div>

                <div class="col-12 mt-2" *ngIf="selectedGroupAgent?.agents?.length > 0">
                  <h6 class="rk-title mb-2">Other Group Members</h6>

                  <table class="table small-table table-borderless">
                    <thead>
                      <tr>
                        <th>Host Name</th>
                        <th>Mc. Address</th>
                        <th>G. Name</th>
                        <th></th>
                      </tr>
                    </thead>

                    <tbody>
                      <tr *ngFor="let item of selectedGroupAgent?.agents">
                        <td>{{ item.agentAlias }}</td>
                        <td style="max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          {{ item.mac | MacAddressFormatterPipe }}
                        </td>
                        <td>{{ item.agentGroup.groupName }}</td>
                        <td class="text-right">
                          <rk-checkbox size="sm" [(value)]="item.selected"></rk-checkbox>
                        </td>
                      </tr>

                      <tr *ngIf="selectedGroupAgent?.length == 0">
                        <td colspan="4">
                          Herhangi bir veri bulunamadı.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="col-12 mt-2">
                  <h6 class="rk-title mb-2">No Group Members</h6>

                  <table class="table small-table table-borderless">
                    <thead>
                      <tr>
                        <th>Host Name</th>
                        <th>Mc. Address</th>
                        <th></th>
                      </tr>
                    </thead>

                    <tbody>
                      <tr *ngFor="let item of unregistereds">
                        <td>{{ item.agentInfo.agentAlias }}</td>
                        <td style="max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          {{ item.agentInfo.mac | MacAddressFormatterPipe }}
                        </td>
                        <td class="text-right">
                          <rk-checkbox size="sm" (valueChange)="selectRow($event, item)" [(value)]="item.selected">
                          </rk-checkbox>
                        </td>
                      </tr>
                      <tr *ngIf="unregistereds.length == 0">
                        <td colspan="3">Herhangi bir veri bulunamadı.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </rk-modal-body>

          <rk-modal-footer>
            <button class="btn w-100 btn-small mr-2" (click)="saveGroupAgent()">Apply</button>
            <button class="btn w-100 btn-default btn-small">Clean</button>
          </rk-modal-footer>
        </rk-modal>

        <div class="col-12 p-0 mt-3">
          <rk-table-container class="m-0">
            <div class="rk-table-container-header">
              <div class="top-content justify-content-between">
                <div class="rk-table-title">Group Agent</div>

                <button class="btn btn-small btn-icon" (click)="createNewGroup()">
                  <i-feather name="plus" class="mr-2"></i-feather>
                  Create New Group
                </button>
              </div>
            </div>

            <rk-table [showPagination]="false">
              <ng-template #header>
                <tr>
                  <th>Group</th>
                  <th>Member Count</th>
                  <th>Security Profile</th>
                  <th colspan="2">Operation</th>
                </tr>
              </ng-template>

              <ng-template #body>
                <tr *ngFor="let device of groupList">
                  <td>
                    {{ device?.agentGroup?.groupName }}
                  </td>
                  <td>{{ device?.agents?.length }}</td>
                  <td>
                    {{ device?.securityProfile?.name }}
                  </td>
                  <td style="width: 60px;">
                    <button class="btn btn-link btn-icon p-0 hover-gray" (click)="editGroupAgentModal(device)">
                      <i-feather name="edit-3"></i-feather>
                    </button>
                  </td>
                  <td style="width: 60px">
                    <button class="btn btn-link btn-icon p-0 hover-gray"
                      (click)="deleteDeviceGroup(device.agentGroup.groupName)">
                      <i-feather name="trash-2"></i-feather>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="groupList.length == 0">
                  <td colspan="5">
                    Herhangi bir veri bulunamadı.
                  </td>
                </tr>
              </ng-template>
            </rk-table>
          </rk-table-container>
        </div>

        <rk-modal #changeGroupModal>
          <rk-modal-header icon="plus">
            <rk-modal-header-title>
              <h5>{{  selectedAgentGroupType === 'edit' ? 'Change' : 'Add to' }} Group</h5>
            </rk-modal-header-title>
            <rk-modal-header-close (click)="changeGroupModal.toggle()"></rk-modal-header-close>
          </rk-modal-header>

          <rk-modal-body>
            <div class="container-fluid">
              <div class="row">
                <div class="col-12 mt-3 d-flex align-items-center justify-content-between">
                  <rk-select [options]="groupListForSelect" [(value)]="selectedGroupId" class="w-100" *ngIf="!showGB">
                  </rk-select>

                  <!-- <button class="btn btn-icon bg-primary fill-white p-1 ml-1" *ngIf="!showGB"
                    style="min-width: 36px; height: 36px;" (click)="showGB = true">
                    <i-feather name="plus" class="mr-0"></i-feather>
                  </button>

                  <input type="text" class="rk-input w-100" placeholder="Group Name" [(ngModel)]="newGroupName"
                    (keyup)="groupNameKeyup($event)" *ngIf="showGB"> -->
                </div>
              </div>

              <div class="row">
               <!--  <div class="col-12 mt-3"  *ngFor="let sp of securityProfiles">
                  <div class="rk-radio my-0">
                    <input type="radio" id="s-{{ sp.id }}" [(ngModel)]="selectedProfileId"
                      name="selectedSecurityProfile" [value]="sp.id">
                    <label for="s-{{ sp.id }}">{{ sp.name }}</label>
                  </div>
                </div> -->

                <div class="col-12 mt-3">
                  <p class="rk-group-title">Select the Devices whose group you want to change</p>
                </div>
              </div>

              <div class="row">
                <div class="col-12 mt-3">
                  <h6 class="rk-title mb-2">Other Group Members</h6>

                  <table class="table small-table table-borderless">
                    <thead>
                      <tr>
                        <th>Host Name</th>
                        <th>Mc. Address</th>
                        <th>G. Name</th>
                        <th></th>
                      </tr>
                    </thead>

                    <tbody>
                      <tr *ngFor="let groupMember of selectedGroupMembers">
                        <td>{{ groupMember.agentAlias ? groupMember.agentAlias : groupMember.agentInfo.agentAlias }}</td>
                        <td style="max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          {{ groupMember.mac ? groupMember.mac : groupMember.agentInfo.mac | MacAddressFormatterPipe }}
                        </td>
                        <td>
                          {{ groupMember?.agentGroup?.groupName ? groupMember?.agentGroup?.groupName : '-' }}
                        </td>
                        <td class="text-right">
                          <rk-checkbox size="sm" [(value)]="groupMember.selected"></rk-checkbox>
                        </td>
                      </tr>
                      <tr *ngIf="selectedGroupMembers.length == 0">
                        <td colspan="4">
                          Herhangi bir veri bulunamadı.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </rk-modal-body>

          <rk-modal-footer>
            <button class="btn btn-small w-100 mr-2" (click)="changeGroupModalApplyClick()">Apply</button>
            <button class="btn btn-small btn-default w-100">Clean</button>
          </rk-modal-footer>
        </rk-modal>

        <div class="col-12 col-md-6 px-0 pr-md-2 mt-3">
          <rk-table-container class="m-0">
            <div class="rk-table-container-header">
              <div class="top-content justify-content-between">
                <div>
                  <div class="rk-table-title">Group Members</div>
                  <p class="rk-table-description">( uyesi oldugu gurubun politikasi uygulanır )</p>
                </div>

                <button class="btn btn-small" (click)="changeTableGroup('edit')">Change Group</button>
              </div>
            </div>

            <rk-table [showPagination]="false">
              <ng-template #header>
                <tr>
                  <th>
                    <rk-checkbox size="sm" (valueChange)="groupMembersTableCheckboxChanged($event)"></rk-checkbox>
                  </th>
                  <th>Hostname</th>
                  <th>Mac Address</th>
                  <th>Group Name</th>
                </tr>
              </ng-template>

              <ng-template #body>
                <tr *ngFor="let device of registereds" [ngClass]="{'selected': device?.selected}">
                  <td style="width: 40px;">
                    <rk-checkbox size="sm" [(value)]="device.selected"></rk-checkbox>
                  </td>
                  <td>{{ device.agentAlias }}</td>
                  <td>{{ device.mac | MacAddressFormatterPipe }}</td>
                  <td>
                    <div class="d-flex align-items-center justify-content-between">
                      <span>{{ device.agentGroup ? device.agentGroup.groupName : '--' }}</span>

                      <button class="btn btn-link btn-icon p-0 hover-gray bg-transparent"
                        (click)="removeDeviceFromRegistereds(device.id)">
                        <i-feather name="trash-2"></i-feather>
                      </button>
                    </div>
                  </td>
                </tr>

                <tr *ngIf="registereds.length == 0">
                  <td colspan="4">
                    Herhangi bir veri bulunamadı.
                  </td>
                </tr>
              </ng-template>
            </rk-table>
          </rk-table-container>
        </div>

        <div class="col-12 col-md-6 px-0 pl-md-2 mt-3">
          <rk-table-container class="m-0">
            <div class="rk-table-container-header">
              <div class="top-content justify-content-between">
                <div>
                  <div class="rk-table-title">Ungroup Members</div>
                  <p class="rk-table-description">( üzerinden çıktığı Dns Relay serverin security profili uygulanır )
                  </p>
                </div>

                <button class="btn btn-small" (click)="changeTableGroup('create')">Add to Group</button>
              </div>
            </div>

            <rk-table [showPagination]="false">
              <ng-template #header>
                <tr>
                  <th>
                    <rk-checkbox size="sm" (valueChange)="ungroupMemberTableCheckboxChanged($event)"></rk-checkbox>
                  </th>
                  <th>Hostname</th>
                  <th>Mac Address</th>
                  <th>Group Name</th>
                </tr>
              </ng-template>

              <ng-template #body>
                <tr *ngFor="let device of unregistereds" [ngClass]="{'selected': device?.selected}">
                  <td style="width: 40px;">
                    <rk-checkbox size="sm" [(value)]="device.selected"></rk-checkbox>
                  </td>
                  <td>{{ device.agentInfo.agentAlias }}</td>
                  <td>{{ device.agentInfo.mac | MacAddressFormatterPipe }}</td>
                  <td>
                    <div class="d-flex align-items-center justify-content-between">
                      <span>No Group</span>

                      <!-- <button class="btn btn-link btn-icon p-0 hover-gray bg-transparent"
                        (click)="deleteUngroupDevice(device)">
                        <i-feather name="trash-2"></i-feather>
                      </button> -->
                    </div>
                  </td>
                </tr>
                <tr *ngIf="unregistereds.length == 0">
                  <td colspan="4">
                    Herhangi bir veri bulunamadı.
                  </td>
                </tr>
              </ng-template>
            </rk-table>
          </rk-table-container>
        </div>
      </div>
    </div>
  </div>
</div>
